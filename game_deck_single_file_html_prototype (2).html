<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameDeck – HTML lobby & roller</title>
  <style>
    :root { --bg:#f7f7fb; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --accent:#4f46e5; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; color:var(--ink); background:linear-gradient(#fafafa,#fff); }
    .container { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 1000px) { .grid { grid-template-columns: 2fr 1fr; } }
    .card { background: var(--card); border:1px solid var(--line); border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .card-h { padding: 12px 16px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px; }
    .title { font-weight:600; font-size: 16px; display:flex; gap:8px; align-items:center; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding: 4px 8px; font-size:12px; border-radius: 999px; background:#f3f4f6; border:1px solid var(--line); color:#111; }
    .muted { color: var(--muted); font-size: 12px; }
    .card-c { padding: 16px; }
    .stage { position: relative; border: 1px dashed var(--line); border-radius: 16px; background: #f8fafc; overflow:hidden; }
    canvas { display:block; background:#fff; margin: 0 auto; border-radius: 8px; }
    .controls { display:flex; flex-wrap: wrap; align-items:center; gap:8px; margin-top: 12px; }
    button, input[type="text"], input[type="color"], input[type="file"], select, input[type="range"] { border:1px solid var(--line); background:#fff; color:#111; border-radius:10px; padding:8px 10px; font:inherit; }
    button { cursor:pointer; }
    button.primary { background: var(--accent); color:#fff; border-color: var(--accent); }
    button.secondary { background:#e5e7eb; }
    .row { display:grid; grid-template-columns: 120px 1fr; gap:8px; align-items:center; margin:8px 0; }
    .avatars { position:absolute; inset:0; pointer-events:none; }
    .avatar { position:absolute; transform:translate(-50%, -50%); filter: drop-shadow(0 2px 4px rgba(0,0,0,.2)); }
    .avatar .dot { width: 16px; height: 16px; border-radius:999px; }
    .avatar .label { margin-top: 2px; padding: 2px 6px; font-size: 12px; background: rgba(255,255,255,.9); border:1px solid var(--line); border-radius:999px; }
    .poll { position:absolute; left:50%; bottom:10px; transform: translateX(-50%); background: rgba(255,255,255,.9); backdrop-filter: blur(4px); border:1px solid var(--line); border-radius: 12px; padding: 8px; display:flex; gap:6px; align-items:center; }
    .chip { padding: 4px 8px; border-radius: 999px; border:1px solid var(--line); background:#fff; font-size:12px; }
    .tips { font-size: 12px; color:var(--muted); }
    .section { margin-bottom: 16px; }
    /* Flerstegs-lobby: visa endast aktiv fas */
    [data-phase] { display:none; }
    [data-phase].active { display:block; }
    .role-buttons { display:flex; flex-direction:column; gap:8px; }
    @media (min-width:600px){ .role-buttons { flex-direction:row; } }
    .bigbtn { flex:1; padding:12px 14px; font-size:15px; display:flex; flex-direction:column; align-items:flex-start; gap:4px; }
    .bigbtn span.small { font-size:12px; color:var(--muted); font-weight:400; }
  </style>
  <!-- PDF.js (via CDN) -->
  <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="grid">
      <!-- LEFT: Stage -->
      <div class="card">
        <div class="card-h">
          <div class="title">
            GameDeck – Scen
            <span id="badge-room" class="badge">Rum: —</span>
            <span id="badge-status" class="badge">Status: Lobby</span>
            <span id="badge-count" class="badge">0 spelare</span>
          </div>
          <div class="muted" id="role-label">Roll: –</div>
        </div>
        <div class="card-c">
          <div class="stage">
            <div style="padding:8px; display:flex; justify-content:center; align-items:center; overflow:auto;">
              <canvas id="slideCanvas"></canvas>
            </div>
            <div class="avatars" id="avatars"></div>
            <div class="poll" id="poll" style="display:none;">
              <span id="poll-q" style="font-weight:600; margin-right:6px;">Fråga?</span>
              <button class="chip" data-opt="0">A <span class="v" data-v="0">0</span></button>
              <button class="chip" data-opt="1">B <span class="v" data-v="1">0</span></button>
              <button class="chip" data-opt="2">C <span class="v" data-v="2">0</span></button>
              <button class="chip" data-opt="3">D <span class="v" data-v="3">0</span></button>
            </div>
          </div>

          <!-- Scenkontroller (aktiva först när spelet startar) -->
          <div class="controls">
            <button id="prev">⏸️ Förra</button>
            <button id="next" class="primary">▶️ Nästa</button>
            <label>Zoom <input id="zoom" type="range" min="0.5" max="2" step="0.1" value="1"> <span id="zoomv" class="muted">×1.0</span></label>
            <button id="export">Exportera PNG</button>
            <button id="newClient">Öppna ny klient</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Sidebar – olika faser -->
      <div class="card">
        <div class="card-h"><div class="title">Lobby & inställningar</div></div>
        <div class="card-c">
          <!-- Fas 1: välj roll -->
          <div data-phase="role" id="ph-role" class="active">
            <div class="section">
              <p><strong>1. Välj roll</strong></p>
              <div class="role-buttons">
                <button id="chooseHost" class="bigbtn primary">
                  Jag är host
                  <span class="small">Skapar rummet, laddar upp presentation, startar spelet.</span>
                </button>
                <button id="choosePlayer" class="bigbtn secondary">
                  Jag är spelare
                  <span class="small">Skriver in rums‑kod, väljer namn/figur och spelar.</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Fas 2: host ser allt direkt -->
          <div data-phase="host" id="ph-host">
            <div class="section">
              <p><strong>2. Rum & host‑inställningar</strong></p>
              <div class="row"><label>Rums‑kod</label><input id="hostRoom" type="text"/></div>
              <div class="row"><label>Ditt namn</label><input id="hostName" type="text" value="Host"/></div>
              <div class="row"><label>Avatarfärg</label><input id="hostColor" type="color" value="#4F46E5"/></div>
              <div class="tips">Dela rums‑koden med spelarna. De väljer "spelare" och skriver in samma kod.</div>
            </div>
            <div class="section">
              <p><strong>3. Ladda presentation</strong></p>
              <div class="row"><label>PDF‑deck</label><input id="pdf" type="file" accept="application/pdf"/></div>
              <div class="tips">Tips: Exportera din PowerPoint till PDF för bästa kompatibilitet.</div>
              <div class="tips" id="pageInfo">Sidor: 0 · Nu: —</div>
            </div>
            <div class="section">
              <p><strong>4. Snabb‑poll (valfritt)</strong></p>
              <div class="row"><label>Fråga</label><input id="pq" type="text" value="Vilken?"/></div>
              <div class="row"><label>Alternativ A</label><input id="p0" type="text" value="A"/></div>
              <div class="row"><label>Alternativ B</label><input id="p1" type="text" value="B"/></div>
              <div class="row"><label>Alternativ C</label><input id="p2" type="text" value="C"/></div>
              <div class="row"><label>Alternativ D</label><input id="p3" type="text" value="D"/></div>
            </div>
            <div class="section">
              <button id="hostStart" class="primary" style="width:100%;">Starta spel</button>
              <div class="tips">När du klickar start går alla anslutna spelare in i spelet samtidigt.</div>
            </div>
          </div>

          <!-- Fas 3: spelare skriver in rum och ansluter -->
          <div data-phase="playerJoin" id="ph-playerJoin">
            <div class="section">
              <p><strong>2. Anslut till rum</strong></p>
              <div class="row"><label>Rums‑kod</label><input id="joinRoom" type="text" placeholder="t.ex. GD-ABCD"/></div>
              <div class="row"><label>Ditt namn</label><input id="joinName" type="text" value="Spelare"/></div>
              <div class="row"><label>Avatarfärg</label><input id="joinColor" type="color" value="#16A34A"/></div>
              <button id="joinBtn" class="primary" style="width:100%;">Anslut</button>
              <div class="tips">Få koden från hosten, skriv in den här och klicka Anslut.</div>
            </div>
          </div>

          <!-- Fas 4: spelare väntar på start -->
          <div data-phase="waiting" id="ph-waiting">
            <div class="section">
              <p><strong>Väntar på start...</strong></p>
              <p class="tips">Du är ansluten till <span id="waitRoom">–</span>. Host kommer starta spelet när alla är inne.</p>
              <div class="row"><label>Namn</label><input id="waitName" type="text"/></div>
              <div class="row"><label>Avatarfärg</label><input id="waitColor" type="color"/></div>
              <div class="tips">Du kan redan nu röra din figur på stora skärmen med WASD/piltangenter.</div>
            </div>
          </div>

          <!-- Fas 5: spelet igång – host kan styra poll härifrån också -->
          <div data-phase="game" id="ph-game">
            <div class="section">
              <p><strong>Spelet är igång</strong></p>
              <p class="tips">Host styr slides och kan starta/stänga poll. Spelare rör sina figurer och röstar.</p>
            </div>
            <div class="section">
              <details>
                <summary><strong>Snabb‑poll under spelet</strong></summary>
                <div class="row"><label>Fråga</label><input id="pq_game" type="text" placeholder="Fråga"/></div>
                <div class="row"><label>Alternativ A</label><input id="p0_game" type="text" placeholder="A"/></div>
                <div class="row"><label>Alternativ B</label><input id="p1_game" type="text" placeholder="B"/></div>
                <div class="row"><label>Alternativ C</label><input id="p2_game" type="text" placeholder="C"/></div>
                <div class="row"><label>Alternativ D</label><input id="p3_game" type="text" placeholder="D"/></div>
                <div class="controls">
                  <button id="pollOpen" class="primary">Öppna poll</button>
                  <button id="pollClose">Stäng poll</button>
                </div>
              </details>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
  // ===== Helpers =====
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const $ = (sel)=>document.querySelector(sel);
  const $$ = (sel)=>Array.from(document.querySelectorAll(sel));

  // ===== State =====
  let role = null; // 'presenter' (host) eller 'audience' (spelare)
  let isHost = false;
  let phase = 'role'; // 'role' | 'host' | 'playerJoin' | 'waiting' | 'game'

  let room = ('GD-' + Math.random().toString(36).slice(2,6)).toUpperCase();
  let name = 'Player';
  let color = '#4F46E5';
  let me = { id: crypto.randomUUID(), name, color, x:0.5, y:0.8 };
  let players = {}; // id -> player

  let poll = { open:false, question:'Vilken?', options:['A','B','C','D'], votes:{} };

  let pdfDoc = null; let page = 1; let numPages = 0; let scale = 1;
  const canvas = document.getElementById('slideCanvas');
  const ctx = canvas.getContext('2d');

  // ===== PDF.js setup =====
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

  async function loadPdfFromFile(file) {
    const arr = await file.arrayBuffer();
    const task = pdfjsLib.getDocument({ data: arr });
    pdfDoc = await task.promise;
    numPages = pdfDoc.numPages; page = 1;
    renderPage(); updatePageInfo();
  }

  async function renderPage(){
    if(!pdfDoc) return;
    const pg = await pdfDoc.getPage(page);
    const viewport = pg.getViewport({ scale });
    canvas.width = viewport.width; canvas.height = viewport.height;
    await pg.render({ canvasContext: ctx, viewport }).promise;
  }

  function updatePageInfo(){
    const el = $('#pageInfo');
    if (el) el.textContent = `Sidor: ${numPages||0} · Nu: ${page}`;
  }

  // ===== Faser =====
  function setPhase(p){
    phase = p;
    $$('[data-phase]').forEach(el=>{
      el.classList.toggle('active', el.getAttribute('data-phase') === phase);
    });
    const status = $('#badge-status');
    if (status){
      if (phase === 'game') status.textContent = 'Status: Spel igång';
      else if (phase === 'waiting') status.textContent = 'Status: Väntar på start';
      else status.textContent = 'Status: Lobby';
    }
    // Uppdatera vänt-läge fält
    if (phase === 'waiting'){
      $('#waitRoom').textContent = room;
      $('#waitName').value = me.name;
      $('#waitColor').value = me.color;
    }
  }

  // ===== Realtime via BroadcastChannel =====
  let chan = null;
  function connect(roomCode){
    if (chan) chan.close();
    chan = ('BroadcastChannel' in window) ? new BroadcastChannel('gdc_'+roomCode) : null;
    if (chan) {
      chan.onmessage = (e)=>{
        const msg = e.data;
        if (msg.t==='state' && typeof msg.page==='number'){ page = msg.page; renderPage(); updatePageInfo(); }
        if (msg.t==='move' && msg.player){ players[msg.player.id] = msg.player; drawAvatars(); }
        if (msg.t==='join' && msg.player){ players[msg.player.id] = msg.player; drawAvatars(); }
        if (msg.t==='poll' && msg.poll){ poll = msg.poll; syncPollUI(); }
        if (msg.t==='start'){ startGame(false); }
      };
      // Announce mig själv
      send({ t:'join', player: me });
    }
  }
  function send(data){ chan && chan.postMessage(data); }

  // ===== Avatars =====
  function drawAvatars(){
    const wrap = $('#avatars');
    wrap.innerHTML = '';
    Object.values(players).forEach(p=> wrap.appendChild(renderAvatar(p,false)));
    wrap.appendChild(renderAvatar(me,true));
    $('#badge-count').textContent = `${Object.keys(players).length + 1} spelare`;
  }
  function renderAvatar(p,isMe){
    const d = document.createElement('div'); d.className='avatar';
    d.style.left = (p.x*100)+'%'; d.style.top = (p.y*100)+'%';
    d.innerHTML = `<div class="dot" style="background:${p.color}"></div><div class="label">${p.name}</div>`;
    return d;
  }

  // Keyboard för figur
  window.addEventListener('keydown', (e)=>{
    const step = 0.02;
    if (['ArrowUp','KeyW'].includes(e.code)) { me.y = clamp(me.y-step,0,1); changed(); }
    if (['ArrowDown','KeyS'].includes(e.code)) { me.y = clamp(me.y+step,0,1); changed(); }
    if (['ArrowLeft','KeyA'].includes(e.code)) { me.x = clamp(me.x-step,0,1); changed(); }
    if (['ArrowRight','KeyD'].includes(e.code)) { me.x = clamp(me.x+step,0,1); changed(); }
  });
  function changed(){ drawAvatars(); send({ t:'move', player: me }); }

  // Gamepad polling
  (function gamepadLoop(){
    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    const p = pads && pads[0];
    if (p) {
      const dx = p.axes[0]||0, dy = p.axes[1]||0;
      if (Math.abs(dx)>0.1 || Math.abs(dy)>0.1){
        me.x = clamp(me.x + dx*0.01, 0, 1);
        me.y = clamp(me.y + dy*0.01, 0, 1);
        changed();
      }
    }
    requestAnimationFrame(gamepadLoop);
  })();

  // ===== Poll UI =====
  function syncPollUI(){
    const box = $('#poll');
    box.style.display = (poll.open && phase==='game') ? 'flex' : 'none';
    $('#poll-q').textContent = poll.question;
    $$('.v').forEach(span=>{
      const idx = +span.getAttribute('data-v');
      span.textContent = String(poll.votes[idx]||0);
    });
  }
  $$('#poll .chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if (!(poll.open && phase==='game')) return;
      const idx = +btn.getAttribute('data-opt');
      poll.votes[idx] = (poll.votes[idx]||0) + 1;
      send({ t:'poll', poll }); syncPollUI();
    });
  });

  // ===== Starta spel (host) =====
  function startGame(fromHost){
    setPhase('game');
    if (fromHost){
      send({ t:'start' });
    }
    // Om host har fyllt i nya poll‑texter i game‑panelen, kopiera dem
    if (isHost){
      const q = $('#pq_game').value || $('#pq').value || 'Vilken?';
      const o0 = $('#p0_game').value || $('#p0').value || 'A';
      const o1 = $('#p1_game').value || $('#p1').value || 'B';
      const o2 = $('#p2_game').value || $('#p2').value || 'C';
      const o3 = $('#p3_game').value || $('#p3').value || 'D';
      poll.question = q;
      poll.options = [o0,o1,o2,o3];
      poll.votes = {};
      send({ t:'poll', poll });
      syncPollUI();
    }
  }

  // ===== Wire UI =====
  // Initial badges
  $('#badge-room').textContent = 'Rum: –';
  $('#role-label').textContent = 'Roll: –';

  // Välj host/spelare
  $('#chooseHost').addEventListener('click', ()=>{
    isHost = true; role = 'presenter';
    $('#role-label').textContent = 'Roll: Host';
    // Sätt rums‑kod i fält
    $('#hostRoom').value = room;
    $('#hostName').value = 'Host';
    $('#hostColor').value = '#4F46E5';
    me.name = 'Host';
    me.color = '#4F46E5';
    $('#badge-room').textContent = 'Rum: ' + room;
    connect(room);
    drawAvatars();
    setPhase('host');
  });

  $('#choosePlayer').addEventListener('click', ()=>{
    isHost = false; role = 'audience';
    $('#role-label').textContent = 'Roll: Spelare';
    setPhase('playerJoin');
  });

  // Host UI
  $('#hostRoom').addEventListener('input', e=>{
    if (!isHost) return;
    room = e.target.value || room;
    $('#badge-room').textContent = 'Rum: ' + room;
    connect(room);
  });
  $('#hostName').addEventListener('input', e=>{
    if (!isHost) return;
    me.name = e.target.value || 'Host';
    changed();
  });
  $('#hostColor').addEventListener('input', e=>{
    if (!isHost) return;
    me.color = e.target.value || '#4F46E5';
    changed();
  });
  $('#pdf').addEventListener('change', e=>{ const f = e.target.files?.[0]; if (f) loadPdfFromFile(f); });

  $('#hostStart').addEventListener('click', ()=>{
    if (!isHost) return;
    startGame(true);
  });

  // Spelare: join‑flöde
  $('#joinBtn').addEventListener('click', ()=>{
    const r = $('#joinRoom').value.trim();
    if (!r) { alert('Skriv in rums‑kod.'); return; }
    room = r.toUpperCase();
    me.name = $('#joinName').value || 'Spelare';
    me.color = $('#joinColor').value || '#16A34A';
    $('#badge-room').textContent = 'Rum: ' + room;
    connect(room);
    drawAvatars();
    setPhase('waiting');
  });

  $('#waitName').addEventListener('input', e=>{
    me.name = e.target.value || me.name;
    changed();
  });
  $('#waitColor').addEventListener('input', e=>{
    me.color = e.target.value || me.color;
    changed();
  });

  // Scenkontroller (bara host och först när spelet igång)
  $('#prev').addEventListener('click', ()=>{
    if (!(isHost && phase==='game')) return;
    page = clamp(page-1,1,numPages||1);
    send({t:'state', page}); renderPage(); updatePageInfo();
  });
  $('#next').addEventListener('click', ()=>{
    if (!(isHost && phase==='game')) return;
    page = clamp(page+1,1,numPages||1);
    send({t:'state', page}); renderPage(); updatePageInfo();
  });
  $('#zoom').addEventListener('input', e=>{
    scale = parseFloat(e.target.value);
    $('#zoomv').textContent = '×'+scale.toFixed(1);
    if (phase==='game') renderPage();
  });
  $('#export').addEventListener('click', ()=>{
    if (phase!=='game') return;
    const url = canvas.toDataURL('image/png');
    const a=document.createElement('a'); a.href=url; a.download = `slide-${Date.now()}.png`; a.click();
  });
  $('#newClient').addEventListener('click', ()=> window.open(location.href, '_blank'));

  // Poll-kontroller (endast host i game‑fas)
  $('#pollOpen').addEventListener('click', ()=>{
    if (!(isHost && phase==='game')) return;
    const q = $('#pq_game').value || $('#pq').value || 'Vilken?';
    const o0 = $('#p0_game').value || $('#p0').value || 'A';
    const o1 = $('#p1_game').value || $('#p1').value || 'B';
    const o2 = $('#p2_game').value || $('#p2').value || 'C';
    const o3 = $('#p3_game').value || $('#p3').value || 'D';
    poll.open = true;
    poll.question = q;
    poll.options = [o0,o1,o2,o3];
    poll.votes = {};
    send({ t:'poll', poll });
    syncPollUI();
  });
  $('#pollClose').addEventListener('click', ()=>{
    if (!(isHost && phase==='game')) return;
    poll.open = false;
    send({t:'poll', poll});
    syncPollUI();
  });

</script>
</body>
</html>